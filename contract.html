<!doctype>
<html>

<head>
<script type="text/javascript" src="js/bignumber.min.js"></script>
<script type="text/javascript" src="js/web3-light.js"></script>
<script type="text/javascript">

  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
    window.web3 = new Web3(web3.currentProvider);
  } else {
    console.log('web3 == undefined');
    console.log('No web3? You should consider trying MetaMask!')
    // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
    window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }

    //var web3 = new Web3(new Web3.providers.HttpProvider('https://ropsten.infura.io/'));

    // solidity code code
    // var source = `
    // pragma solidity ^0.4.6;
    // contract test {
    //    function multiply(uint a) constant returns(uint d) {
    //        return a * 7;
    //    }
    // }`;
    var source = 'contract test { function g() {} }'

    //var solc = require("solc");
    //var compiled = solc.compile(source);
    //var bytecode = compiled.contracts[":test"].bytecode;
    // original test(multiply) bytecode
    // var bytecode = '6060604052341561000f57600080fd5b60b18061001d6000396000f300606060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063c6888fa1146044575b600080fd5b3415604e57600080fd5b606260048080359060200190919050506078565b6040518082815260200191505060405180910390f35b60006007820290509190505600a165627a7a723058209f98d1ea430bb5398ce0b6d37fc3ace8592eabbd23bca6d51484bd7338912f690029';

    // short test(g) bytecode, add 0x in front of the bytecode string
    var bytecode = '60606040523415600e57600080fd5b60848061001c6000396000f300606060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063e2179b8e146044575b600080fd5b3415604e57600080fd5b60546056565b005b5600a165627a7a723058206a3fd16bc8a51eb4613183091a69cfe7d5e0b2af70a6291a23a03b912ad0ad5c0029';

    // contract json abi, this is autogenerated using solc CLI
    //var abi = compiled.contracts[":test"].interface;
    //var abi = JSON.parse('[{"constant":true,"inputs":[{"name":"a","type":"uint256"}],"name":"multiply","outputs":[{"name":"d","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}]');
    var abi = JSON.parse('[{"constant":false,"inputs":[],"name":"g","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]');

    web3.eth.getAccounts((error, a) => { console.log(a); });
    //web3.personal.unlockAccount("0x3b2a4e7124c3cdedddff191b585e575022342fb8","pub", 15000);

    var myContract;

    function createExampleContract() {
        // hide create button
        document.getElementById('create').style.visibility = 'hidden';
        document.getElementById('code').innerText = code;

        // send ether
        // var sender   = '0xd4D2Ac77D72AdF6C560387F79E39394E12e7dCfA';
        // var receiver = '0xA6190a8c30C9F42f11981f2dcFc8f75854d2dD23';
        // var amount   = web3.toWei(1.23, "ether");
        // web3.eth.sendTransaction({from:sender, to:receiver, value: amount}, (a) => { console.log(a); });

        // let's assume that coinbase is our account
        web3.eth.defaultAccount = web3.eth.coinbase;

        // create contract
        document.getElementById('status').innerText = "transaction sent, waiting for confirmation";
        web3.eth.contract(abi).new({data: '0x' + bytecode}, function (err, contract) {
            if(err) {
                console.error(err);
                return;

            // callback fires twice, we only want the second call when the contract is deployed
            } else if(contract.address){

                myContract = contract;
                console.log('address: ' + myContract.address);
                document.getElementById('status').innerText = 'Mined!';
                document.getElementById('call').style.visibility = 'visible';
            }
        });
    }

    function callExampleContract() {
        // this should be generated by ethereum
        var param = parseInt(document.getElementById('value').value);

        // call the contract
        var res = myContract.multiply(param);
        document.getElementById('result').innerText = res.toString(10);
    }

</script>
</head>
<body>
    <h1>contract</h1>
    <div id="code"></div>
    <div id="status"></div>
    <div id='create'>
        <button type="button" onClick="createExampleContract();">create example contract</button>
        <button type="button" onClick="sendTransaction();">send transaction</button>
        <button type="button" onClick="callContract();">call contract</button>
    </div>
    <div id='call' style='visibility: hidden;'>
        <input type="number" id="value" onkeyup='callExampleContract()'></input>
    </div>
    <div id="result"></div>
</body>
</html>
